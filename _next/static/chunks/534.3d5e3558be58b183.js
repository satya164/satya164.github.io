"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[534],{1534:function(e,t,a){a.d(t,{afterInsert:function(){return A},searchWithHighlight:function(){return P}});var r=a(7406),o=a(6855),n=a(4479);let i="fulltext";var l=a(4891);function s(e,t){return e[1]-t[1]}function c(e,t){return t[1]-e[1]}async function u(e,t,a){let r={},i=t.map(([e])=>e),l=await e.documentsStore.getMultiple(e.data.docs,i),u=Object.keys(a),d=await e.index.getSearchablePropertiesWithTypes(e.data.index);for(let e of u){let t;if("number"===d[e]){let{ranges:r}=a[e],o=r.length,n=Array.from({length:o});for(let e=0;e<o;e++){let t=r[e];n[e]=[`${t.from}-${t.to}`,0]}t=Object.fromEntries(n)}r[e]={count:0,values:t??{}}}let p=l.length;for(let e=0;e<p;e++){let t=l[e];for(let e of u){let i=e.includes(".")?await (0,n.Sf)(t,e):t[e],l=d[e],s=r[e].values;switch(l){case"number":f(a[e].ranges,s)(i);break;case"number[]":{let t=new Set,r=f(a[e].ranges,s,t);for(let e of i)r(e);break}case"boolean":case"enum":case"string":h(s,l)(i);break;case"boolean[]":case"enum[]":case"string[]":{let e=h(s,"boolean[]"===l?"boolean":"string",new Set);for(let t of i)e(t);break}default:throw(0,o.T)("FACET_NOT_SUPPORTED",l)}}}for(let e of u){let t=r[e];if(t.count=Object.keys(t.values).length,"string"===d[e]){let r=a[e],o=function(e="desc"){return"asc"===e.toLowerCase()?s:c}(r.sort);t.values=Object.fromEntries(Object.entries(t.values).sort(o).slice(r.offset??0,r.limit??10))}}return r}function f(e,t,a){return r=>{for(let o of e){let e=`${o.from}-${o.to}`;(null==a||!a.has(e))&&r>=o.from&&r<=o.to&&(void 0===t[e]?t[e]=1:(t[e]++,null==a||a.add(e)))}}}function h(e,t,a){let r="boolean"===t?"false":"";return t=>{let o=(null==t?void 0:t.toString())??r;null!=a&&a.has(o)||(e[o]=(e[o]??0)+1,null==a||a.add(o))}}function d(e,t){let a=new Map,r=[];for(let t of e)a.set(t,!0);for(let e of t){let[t]=e;a.has(t)&&(r.push(e),a.delete(t))}return r}let p={reducer:(e,t,a,r)=>(t[r]=a,t),getInitialValue:e=>Array.from({length:e})},w=["string","number","boolean"];async function g(e,t,a){let i=a.properties,l=i.length,s=await e.index.getSearchablePropertiesWithTypes(e.data.index);for(let e=0;e<l;e++){let t=i[e];if(void 0===s[t])throw(0,o.T)("UNKNOWN_GROUP_BY_PROPERTY",t);if(!w.includes(s[t]))throw(0,o.T)("INVALID_GROUP_BY_PROPERTY",t,w.join(", "),s[t])}let c=t.map(([t])=>(0,r.K7)(e.internalDocumentIDStore,t)),u=await e.documentsStore.getMultiple(e.data.docs,c),f=u.length,h=a.maxResult||Number.MAX_SAFE_INTEGER,d=[],g={};for(let e=0;e<l;e++){let t=i[e],a={property:t,perValue:{}},r=new Set;for(let e=0;e<f;e++){let o=u[e],i=await (0,n.Sf)(o,t);if(void 0===i)continue;let l="boolean"!=typeof i?i:""+i,s=a.perValue[l]??{indexes:[],count:0};s.count>=h||(s.indexes.push(e),s.count++,a.perValue[l]=s,r.add(i))}d.push(Array.from(r)),g[t]=a}let m=function e(t,a=0){if(a+1===t.length)return t[a].map(e=>[e]);let r=t[a],o=e(t,a+1),i=[];for(let e of r)for(let t of o){let a=[e];(0,n.hT)(a,t),i.push(a)}return i}(d),b=m.length,y=[];for(let e=0;e<b;e++){let t=m[e],a=t.length,r={values:[],indexes:[]},o=[];for(let e=0;e<a;e++){let a=t[e],n=i[e];o.push(g[n].perValue["boolean"!=typeof a?a:""+a].indexes),r.values.push(a)}r.indexes=(0,n.wf)(o).sort((e,t)=>e-t),0!==r.indexes.length&&y.push(r)}let S=y.length,v=Array.from({length:S});for(let e=0;e<S;e++){let r=y[e],o=a.reduce||p,n=r.indexes.map(e=>({id:c[e],score:t[e][1],document:u[e]})),i=o.reducer.bind(null,r.values),l=o.getInitialValue(r.indexes.length),s=n.reduce(i,l);v[e]={values:r.values,result:s}}return v}var m=a(8287);async function b(e,t,a){let i;let s=await (0,n.XN)();e.beforeSearch&&await (0,m.et)(e.beforeSearch,e,t,a),t.relevance=Object.assign(k,t.relevance??{});let c=Object.keys(e.data.index.vectorIndexes),f=t.facets&&Object.keys(t.facets).length>0,{limit:h=10,offset:p=0,term:w,properties:b,threshold:y=1,distinctOn:S,includeVectors:v=!1}=t,x=!0===t.preflight,{index:I,docs:O}=e.data,D=await e.tokenizer.tokenize(w??"",a),j=e.caches.propertiesToSearch;if(!j){let t=await e.index.getSearchablePropertiesWithTypes(I);j=(j=await e.index.getSearchableProperties(I)).filter(e=>t[e].startsWith("string")),e.caches.propertiesToSearch=j}if(b&&"*"!==b){for(let e of b)if(!j.includes(e))throw(0,o.T)("UNKNOWN_INDEX",e,j.join(", "));j=j.filter(e=>b.includes(e))}let E=await T(e.tokenizer,e.index,e.documentsStore,a,t,j,D,await e.documentsStore.count(O),s),A=Object.keys(t.where??{}).length>0,z=[];A&&(z=await e.index.searchByWhereClause(E,I,t.where));let M=D.length;if(M||(null==b?void 0:b.length)){let a=j.length;for(let r=0;r<a;r++){var P;let a=j[r],o=E.indexMap[a];if(0!==M)for(let t=0;t<M;t++){let r=D[t],i=await e.index.search(E,I,a,r);(0,n.hT)(o[r],i)}else{o[""]=[];let t=await e.index.search(E,I,a,"");(0,n.hT)(o[""],t)}let i=Object.values(o);E.docsIntersection[a]=(0,l.U)(i,(null==t?void 0:null===(P=t.boost)||void 0===P?void 0:P[a])??1,y,M);let s=E.docsIntersection[a],c=s.length;for(let e=0;e<c;e++){let[t,a]=s[e],r=E.uniqueDocsIDs[t];r?E.uniqueDocsIDs[t]=r+a+.5:E.uniqueDocsIDs[t]=a}}}else 0===D.length&&w?E.uniqueDocsIDs={}:E.uniqueDocsIDs=Object.fromEntries(Object.keys(await e.documentsStore.getAll(e.data.docs)).map(e=>[e,0]));let B=Object.entries(E.uniqueDocsIDs).map(([e,t])=>[+e,t]);if(A&&(B=d(z,B)),t.sortBy){if("function"==typeof t.sortBy){let a=B.map(([e])=>e),r=(await e.documentsStore.getMultiple(e.data.docs,a)).map((e,t)=>[B[t][0],B[t][1],e]);r.sort(t.sortBy),B=r.map(([e,t])=>[e,t])}else B=await e.sorter.sortBy(e.data.sorting,B,t.sortBy).then(t=>t.map(([t,a])=>[(0,r.HM)(e.internalDocumentIDStore,t),a]))}else B=B.sort(n.XO);x||(i=await (S?N(e,B,p,h,S):_(e,B,p,h)));let W={elapsed:{formatted:"",raw:0},hits:[],count:B.length};if(void 0===i||(W.hits=i.filter(Boolean),v||(0,n.ZL)(W,c)),f){let a=await u(e,B,t.facets);W.facets=a}return t.groupBy&&(W.groups=await g(e,B,t.groupBy)),e.afterSearch&&await (0,m.mX)(e.afterSearch,e,t,a,W),W.elapsed=await e.formatElapsedTime(await (0,n.XN)()-E.timeStart),W}var y=a(2574);async function S(e,t,a="english"){let i=await (0,n.XN)();e.beforeSearch&&await (0,m.et)(e.beforeSearch,e,t,a);let{vector:l}=t;if(l&&(!("value"in l)||!("property"in l)))throw(0,o.T)("INVALID_VECTOR_INPUT",Object.keys(l).join(", "));let{limit:s=10,offset:c=0,includeVectors:f=!1}=t,h=e.data.index.vectorIndexes[l.property],p=h.size,w=h.vectors,b=t.facets&&Object.keys(t.facets).length>0,S=Object.keys(t.where??{}).length>0,{index:v,docs:x}=e.data;if((null==l?void 0:l.value.length)!==p)throw(0,o.T)("INVALID_INPUT_VECTOR",null==l?void 0:l.property,p,null==l?void 0:l.value.length);l instanceof Float32Array||(l.value=new Float32Array(l.value));let I=(0,y.M)(l.value,w,p,t.similarity).map(([t,a])=>[(0,r.HM)(e.internalDocumentIDStore,t),a]),O=e.caches.propertiesToSearch;if(!O){let t=await e.index.getSearchablePropertiesWithTypes(v);O=(O=await e.index.getSearchableProperties(v)).filter(e=>t[e].startsWith("string")),e.caches.propertiesToSearch=O}let D=await T(e.tokenizer,e.index,e.documentsStore,a,t,O,[],await e.documentsStore.count(x),i);S&&(I=d(await e.index.searchByWhereClause(D,v,t.where),I));let k=[];b&&(k=await u(e,I,t.facets));let j=Array.from({length:s});for(let t=0;t<s;t++){let a=I[t+c];if(!a)break;let o=e.data.docs.docs[a[0]];if(o){f||(o[l.property]=null);let n={id:(0,r.K7)(e.internalDocumentIDStore,a[0]),score:a[1],document:o};j[t]=n}}let N=[];t.groupBy&&(N=await g(e,I,t.groupBy)),e.afterSearch&&await (0,m.mX)(e.afterSearch,e,t,a,I);let _=await (0,n.XN)()-i;return{count:I.length,hits:j.filter(Boolean),elapsed:{raw:Number(_),formatted:await (0,n.Ed)(_)},...k?{facets:k}:{},...N?{groups:N}:{}}}async function v(e,t,a){let r,i;let l=await (0,n.XN)();e.beforeSearch&&await (0,m.et)(e.beforeSearch,e,t,a);let{offset:s=0,limit:c=10,includeVectors:f=!1}=t,h=t.facets&&Object.keys(t.facets).length>0,[p,w]=await Promise.all([x(e,t,a),I(e,t)]),{index:b,docs:y}=e.data,S=t.hybridWeights,v=function(e,t,a,r){let o=Math.max.apply(Math,e.map(O)),n=Math.max.apply(Math,t.map(O)),{text:i,vector:l}=r&&r.text&&r.vector?r:{text:.5,vector:.5},s=new Map,c=e.length,u=(e,t)=>e*i+t*l;for(let t=0;t<c;t++){let[a,r]=e[t],n=u(r/o,0);s.set(a,n)}let f=t.length;for(let e=0;e<f;e++){let[a,r]=t[e],o=r/n,i=s.get(a)??0;s.set(a,i+u(0,o))}return[...s].sort((e,t)=>t[1]-e[1])}(p,w,t.term,S),D=await e.tokenizer.tokenize(t.term??"",a),k=e.caches.propertiesToSearch;if(!k){let t=await e.index.getSearchablePropertiesWithTypes(b);k=(k=await e.index.getSearchableProperties(b)).filter(e=>t[e].startsWith("string")),e.caches.propertiesToSearch=k}if(t.properties&&"*"!==t.properties){for(let e of t.properties)if(!k.includes(e))throw(0,o.T)("UNKNOWN_INDEX",e,k.join(", "));k=k.filter(e=>t.properties.includes(e))}let j=await T(e.tokenizer,e.index,e.documentsStore,a,t,k,D,await e.documentsStore.count(y),l),N=Object.keys(t.where??{}).length>0;N&&(v=d(await e.index.searchByWhereClause(j,b,t.where),v)),h&&(r=await u(e,v,t.facets)),t.groupBy&&(i=await g(e,v,t.groupBy));let E=(await _(e,v,s,c)).filter(Boolean);e.afterSearch&&await (0,m.mX)(e.afterSearch,e,t,a,E);let A=await (0,n.XN)(),z={count:v.length,elapsed:{raw:Number(A-l),formatted:await (0,n.Ed)(A-l)},hits:E,...r?{facets:r}:{},...i?{groups:i}:{}};if(!f){let t=Object.keys(e.data.index.vectorIndexes);(0,n.ZL)(z,t)}return z}async function x(e,t,a){let r=await (0,n.XN)();t.relevance=Object.assign(k,t.relevance??{});let{term:i="",properties:s,threshold:c=1}=t,{index:u,docs:f}=e.data,h=await e.tokenizer.tokenize(i,a),d=e.caches.propertiesToSearch;if(!d){let t=await e.index.getSearchablePropertiesWithTypes(u);d=(d=await e.index.getSearchableProperties(u)).filter(e=>t[e].startsWith("string")),e.caches.propertiesToSearch=d}if(s&&"*"!==s){let e=new Set(d),t=new Set(s);for(let t of s)if(!e.has(t))throw(0,o.T)("UNKNOWN_INDEX",t,d.join(", "));d=d.filter(e=>t.has(e))}let p=await T(e.tokenizer,e.index,e.documentsStore,a,t,d,h,await e.documentsStore.count(f),r),w=h.length;if(w||s&&s.length>0){let a=d.length;for(let r=0;r<a;r++){var g;let a=d[r];if(0!==w)for(let t=0;t<w;t++){let r=h[t],o=await e.index.search(p,u,a,r);(0,n.hT)(p.indexMap[a][r],o)}else{let t=[];p.indexMap[a][""]=t;let r=await e.index.search(p,u,a,"");(0,n.hT)(t,r)}let o=Object.values(p.indexMap[a]);p.docsIntersection[a]=(0,l.U)(o,(null==t?void 0:null===(g=t.boost)||void 0===g?void 0:g[a])??1,c,w);let i=p.docsIntersection[a],s=i.length;for(let e=0;e<s;e++){let[t,a]=i[e],r=p.uniqueDocsIDs[t];p.uniqueDocsIDs[t]=r?r+a+.5:a}}}else 0===h.length&&i?p.uniqueDocsIDs={}:p.uniqueDocsIDs=Object.fromEntries(Object.keys(await e.documentsStore.getAll(e.data.docs)).map(e=>[e,0]));return D(Object.entries(p.uniqueDocsIDs).map(([e,t])=>[+e,t]).sort((e,t)=>t[1]-e[1]))}async function I(e,t){let a=t.vector,n=e.data.index.vectorIndexes[null==a?void 0:a.property],i=n.size,l=n.vectors;if(a&&(!a.value||!a.property))throw(0,o.T)("INVALID_VECTOR_INPUT",Object.keys(a).join(", "));if(a.value.length!==i)throw(0,o.T)("INVALID_INPUT_VECTOR",a.property,i,a.value.length);return a instanceof Float32Array||(a.value=new Float32Array(a.value)),D((0,y.M)(a.value,l,i,t.similarity).map(([t,a])=>[(0,r.HM)(e.internalDocumentIDStore,t),a]))}function O([,e]){return e}function D(e){let t=Math.max.apply(Math,e.map(O));return e.map(([e,a])=>[e,a/t])}let k={k:1.2,b:.75,d:.5};async function T(e,t,a,r,o,n,i,l,s){let c={},u={};for(let e of n){let t={};for(let e of i)t[e]=[];c[e]=t,u[e]=[]}return{timeStart:s,tokenizer:e,index:t,documentsStore:a,language:r,params:o,docsCount:l,uniqueDocsIDs:{},indexMap:c,docsIntersection:u}}async function j(e,t,a){let r=t.mode??i;if(r===i)return b(e,t,a);if("vector"===r)return S(e,t);if("hybrid"===r)return v(e,t);throw(0,o.T)("INVALID_SEARCH_MODE",r)}async function N(e,t,a,o,i){let l=e.data.docs,s=new Map,c=[],u=new Set,f=t.length,h=0;for(let d=0;d<f;d++){let f=t[d];if(void 0===f)continue;let[p,w]=f;if(u.has(p))continue;let g=await e.documentsStore.get(l,p),m=await (0,n.Sf)(g,i);if(!(void 0===m||s.has(m))&&(s.set(m,!0),!(++h<=a)&&(c.push({id:(0,r.K7)(e.internalDocumentIDStore,p),score:w,document:g}),u.add(p),h>=a+o)))break}return c}async function _(e,t,a,o){let n=e.data.docs,i=Array.from({length:o}),l=new Set;for(let s=a;s<o+a;s++){let a=t[s];if(void 0===a)break;let[o,c]=a;if(!l.has(o)){let t=await e.documentsStore.get(n,o);i[s]={id:(0,r.K7)(e.internalDocumentIDStore,o),score:c,document:t},l.add(o)}}return i}var E=a(5204);async function A(e,t){"positions"in e.data||Object.assign(e.data,{positions:{}}),await M(e,await e.documentsStore.get(e.data.docs,t),t)}let z=/[\p{L}0-9_'-]+/gimu;async function M(e,t,a,r="",o=e.schema){for(let n of(e.data.positions[a]=Object.create(null),Object.keys(t))){let i;let l="object"==typeof t[n],s="object"==typeof o[n],c=`${r}${String(n)}`;if(l&&n in o&&s&&M(e,t[n],a,c+".",o[n]),!("string"==typeof t[n]&&n in o&&!s))continue;e.data.positions[a][c]=Object.create(null);let u=t[n];for(;null!==(i=z.exec(u));){let t;let r=i[0].toLowerCase(),o=`${e.tokenizer.language}:${r}`;e.tokenizer.normalizationCache.has(o)?t=e.tokenizer.normalizationCache.get(o):([t]=await e.tokenizer.tokenize(r),e.tokenizer.normalizationCache.set(o,t)),Array.isArray(e.data.positions[a][c][t])||(e.data.positions[a][c][t]=[]);let n=i.index,l=i[0].length;e.data.positions[a][c][t].push({start:n,length:l})}}}async function P(e,t,a){let r=await j(e,t,a),o=await e.tokenizer.tokenize(t.term??"",a),n=[];for(let a of r.hits){let r=Object.entries(e.data.positions[a.id]),i=[];for(let[e,a]of r){let r=[];for(let e of Object.entries(a)){let[a]=e;for(let n of o)if(t.tolerance){if((await (0,E.XQ)(a,n,t.tolerance)).isBounded){r.push(e);break}}else if(a.startsWith(n)){r.push(e);break}}i.push([e,Object.fromEntries(r)])}n.push(Object.assign(a,{positions:Object.fromEntries(i)}))}return r.hits=n,r}}}]);